trigger: none

resources:
  pipelines:
    - pipeline: ci-pipeline
      source: 'icinema-ci-pipeline'
      trigger:
        branches: ['main']

pool:
  vmImage: 'ubuntu-latest'

variables:
  azureSubscription: 'azure-connection-cicd'
  webAppName: 'icinema-api-demo2'
  resourceGroup: 'rg-icinema-academic'
  # AGREGAR ESTA VARIABLE CR√çTICA:
  imageRepository: 'daldeoscoder/icinema-api'

stages:
  - stage: Deploy
    displayName: Deploy to Azure
    jobs:
      - deployment: Deploy
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebAppContainer@1
                  displayName: 'Deploy to Azure Web App'
                  inputs:
                    azureSubscription: $(azureSubscription)
                    appName: $(webAppName)
                    # CORREGIR: Usar el tag del pipeline CI
                    containers: '$(imageRepository):latest'
                    appSettings: |
                      -name DATABASE_URL -value "$(DATABASE_URL)"
                      -name WEBSITES_PORT -value "8000"